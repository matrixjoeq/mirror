{% extends "base.html" %}

{% block title %}时间段策略比较 - 多策略系统分析{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-range"></i> 时间段策略比较
                    <a href="{{ url_for('analysis.strategy_scores') }}" class="btn btn-outline-secondary btn-sm float-end">
                        <i class="bi bi-arrow-left"></i> 返回策略评分
                    </a>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="text-muted">
                            按时间段分析不同策略的表现变化，帮助您了解策略的时效性和适应性。
                        </p>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">时间粒度:</label>
                        <select class="form-select" id="periodTypeSelect" onchange="changePeriodType()">
                            <option value="year" {{ 'selected' if period_type == 'year' else '' }}>按年</option>
                            <option value="quarter" {{ 'selected' if period_type == 'quarter' else '' }}>按季度</option>
                            <option value="month" {{ 'selected' if period_type == 'month' else '' }}>按月</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if periods %}
<div class="row">
    {% for period in periods %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header text-center bg-light">
                <h6 class="card-title mb-0">
                    {% if period_type == 'year' %}
                    {{ period }}年
                    {% elif period_type == 'quarter' %}
                    {{ period }}
                    {% else %}
                    {{ period }}
                    {% endif %}
                </h6>
            </div>
            <div class="card-body">
                <!-- 各策略得分预览 -->
                <div class="row text-center small mb-3">
                    {% set colors = ['primary', 'success', 'warning', 'info', 'danger', 'secondary'] %}
                    {% set icons = ['graph-up', 'arrow-repeat', 'grid', 'diagram-3', 'bar-chart', 'gear'] %}
                    
                    {% for strategy in strategies_data %}
                    {% set color_idx = loop.index0 % colors|length %}
                    {% set color = colors[color_idx] %}
                    {% set icon = icons[color_idx] %}
                    <div class="col-6 mb-2">
                        <div class="border rounded p-2">
                            <i class="bi bi-{{ icon }} text-{{ color }}"></i>
                            <div class="small text-muted">{{ strategy.name }}</div>
                            <div class="badge bg-{{ color }} loading-score" 
                                 data-period="{{ period }}" 
                                 data-strategy="{{ strategy.id }}"
                                 data-period-type="{{ period_type }}">-</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- 期间表现预览 -->
                <div class="text-center">
                    <div class="small text-muted mb-2">期间表现</div>
                    <div class="period-performance" data-period="{{ period }}">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-center">
                 <a href="{{ url_for('analysis.time_detail', period=period) }}?period_type={{ period_type }}" 
                   class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> 详细分析
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 时间趋势图 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> 策略表现趋势
                </h6>
            </div>
            <div class="card-body">
                <canvas id="trendChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-calendar-x" style="font-size: 3rem; color: #dee2e6;"></i>
                <h5 class="mt-3 text-muted">暂无时间段数据</h5>
                <p class="text-muted">还没有已平仓的交易记录，无法进行时间段分析。</p>
                <a href="{{ url_for('trading.add_buy') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> 添加交易记录
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 分析说明 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> 时间段分析说明
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>时间粒度</h6>
                        <ul class="small">
                            <li><strong>按年</strong>：观察策略的年度表现和长期趋势</li>
                            <li><strong>按季度</strong>：分析策略的季节性表现</li>
                            <li><strong>按月</strong>：识别策略的短期波动和效果</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>分析维度</h6>
                        <ul class="small">
                            <li><strong>时效性</strong>：策略在不同时期的适应性</li>
                            <li><strong>稳定性</strong>：策略表现的一致性</li>
                            <li><strong>趋势性</strong>：策略效果的变化趋势</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>应用价值</h6>
                        <ul class="small">
                            <li><strong>策略调整</strong>：根据时间表现优化策略</li>
                            <li><strong>周期管理</strong>：识别策略的最佳使用时机</li>
                            <li><strong>风险控制</strong>：避免在不利时期使用特定策略</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periods = [
        {% for period in periods %}
        '{{ period }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const periodType = '{{ period_type }}';
    
    // 异步加载每个时间段的策略评分
    periods.forEach(period => {
        loadPeriodScores(period, periodType);
    });
    
    // 加载趋势图数据
    loadTrendChart();
});

async function loadPeriodScores(period, periodType) {
    const strategiesData = {{ strategies_data | tojson }};
    let bestStrategy = null;
    let bestScore = -1;
    let sumScore = 0;
    let validStrategies = 0;
    
    for (const strategy of strategiesData) {
        try {
            // 获取时间段的开始和结束日期
            const dateRange = getPeriodDateRange(period, periodType);
            const response = await fetch(`/api/strategy_score?strategy_id=${strategy.id}&start_date=${dateRange.start}&end_date=${dateRange.end}`);
            const { success, data } = await response.json();
            
            // 更新得分显示
            const scoreElement = document.querySelector(`[data-period="${period}"][data-strategy="${strategy.id}"]`);
            if (scoreElement && success) {
                const totalScore = (data.win_rate_score || 0) + (data.profit_loss_ratio_score || 0) + (data.frequency_score || 0);
                scoreElement.textContent = totalScore;
                
                // 根据评级设置颜色
                scoreElement.className = scoreElement.className.replace(/bg-\w+/, '');
                if (totalScore >= 23) {
                    scoreElement.classList.add('bg-success');
                } else if (totalScore >= 20) {
                    scoreElement.classList.add('bg-info');
                } else if (totalScore >= 18) {
                    scoreElement.classList.add('bg-warning');
                } else {
                    scoreElement.classList.add('bg-danger');
                }
            }
            
            // 统计最佳策略和平均表现
            if (success && data.stats.total_trades > 0) {
                sumScore += totalScore;
                validStrategies++;
                
                if (totalScore > bestScore) {
                    bestScore = totalScore;
                    bestStrategy = {
                        name: strategy.name,
                        score: totalScore,
                        rating: ''
                    };
                }
            }
        } catch (error) {
            console.error(`Failed to load score for ${strategy.name} in ${period}:`, error);
            const scoreElement = document.querySelector(`[data-period="${period}"][data-strategy="${strategy.id}"]`);
            if (scoreElement) {
                scoreElement.textContent = 'N/A';
                scoreElement.classList.add('bg-secondary');
            }
        }
    }
    
    // 更新期间表现
    const performanceElement = document.querySelector(`.period-performance[data-period="${period}"]`);
    if (performanceElement) {
        if (bestStrategy && validStrategies > 0) {
            const avgScore = (sumScore / validStrategies).toFixed(1);
            performanceElement.innerHTML = `
                <div class="small">
                    <div class="badge bg-success mb-1">${bestStrategy.name}</div>
                    <div>最高: ${bestStrategy.score}分</div>
                    <div class="text-muted">平均: ${avgScore}分</div>
                </div>
            `;
        } else {
            performanceElement.innerHTML = '<div class="text-muted small">暂无数据</div>';
        }
    }
}

function getPeriodDateRange(period, periodType) {
    if (periodType === 'year') {
        return {
            start: `${period}-01-01`,
            end: `${period}-12-31`
        };
    } else if (periodType === 'quarter') {
        const [year, quarter] = period.split('-Q');
        const quarters = {
            '1': { start: `${year}-01-01`, end: `${year}-03-31` },
            '2': { start: `${year}-04-01`, end: `${year}-06-30` },
            '3': { start: `${year}-07-01`, end: `${year}-09-30` },
            '4': { start: `${year}-10-01`, end: `${year}-12-31` }
        };
        return quarters[quarter];
    } else if (periodType === 'month') {
        const [year, month] = period.split('-');
        const daysInMonth = new Date(year, month, 0).getDate();
        return {
            start: `${year}-${month}-01`,
            end: `${year}-${month}-${daysInMonth.toString().padStart(2, '0')}`
        };
    }
}

async function loadTrendChart() {
    try {
        const response = await fetch(`/api/strategy_trend?period_type={{ period_type }}`);
        const trendData = await response.json();
        
        drawTrendChart(trendData);
    } catch (error) {
        console.error('Failed to load trend data:', error);
        
        // 显示错误占位符
        const canvas = document.getElementById('trendChart');
        const ctx = canvas.getContext('2d');
        
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#dc3545';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('趋势图加载失败', canvas.width / 2, canvas.height / 2);
    }
}

function drawTrendChart(trendData) {
    const canvas = document.getElementById('trendChart');
    const ctx = canvas.getContext('2d');
    
    // 清除画布
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const margin = { top: 40, right: 120, bottom: 60, left: 60 };
    const chartWidth = canvas.width - margin.left - margin.right;
    const chartHeight = canvas.height - margin.top - margin.bottom;
    
    const periods = trendData.periods;
    const strategies = trendData.strategies;
    
    if (periods.length === 0 || strategies.length === 0) {
        ctx.fillStyle = '#6c757d';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('暂无趋势数据', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // 策略颜色
    const colors = ['#0d6efd', '#198754', '#ffc107', '#0dcaf0', '#dc3545', '#6f42c1'];
    
    // 绘制背景网格
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 1;
    
    // 垂直网格线
    for (let i = 0; i <= periods.length - 1; i++) {
        const x = margin.left + (i / Math.max(periods.length - 1, 1)) * chartWidth;
        ctx.beginPath();
        ctx.moveTo(x, margin.top);
        ctx.lineTo(x, margin.top + chartHeight);
        ctx.stroke();
    }
    
    // 水平网格线
    for (let i = 0; i <= 10; i++) {
        const y = margin.top + (i / 10) * chartHeight;
        ctx.beginPath();
        ctx.moveTo(margin.left, y);
        ctx.lineTo(margin.left + chartWidth, y);
        ctx.stroke();
    }
    
    // 绘制坐标轴
    ctx.strokeStyle = '#495057';
    ctx.lineWidth = 2;
    
    // Y轴
    ctx.beginPath();
    ctx.moveTo(margin.left, margin.top);
    ctx.lineTo(margin.left, margin.top + chartHeight);
    ctx.stroke();
    
    // X轴
    ctx.beginPath();
    ctx.moveTo(margin.left, margin.top + chartHeight);
    ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
    ctx.stroke();
    
    // Y轴标签（分数）
    ctx.fillStyle = '#495057';
    ctx.font = '12px Arial';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 10; i += 2) {
        const y = margin.top + chartHeight - (i / 10) * chartHeight;
        ctx.fillText((i * 3).toString(), margin.left - 10, y + 4);
    }
    
    // X轴标签（时间段）
    ctx.textAlign = 'center';
    periods.forEach((period, index) => {
        const x = margin.left + (index / Math.max(periods.length - 1, 1)) * chartWidth;
        ctx.fillText(period, x, margin.top + chartHeight + 20);
    });
    
    // 绘制策略趋势线
    strategies.forEach((strategy, strategyIndex) => {
        const color = colors[strategyIndex % colors.length];
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 2;
        
        // 绘制趋势线
        ctx.beginPath();
        let hasValidPoint = false;
        
        strategy.scores.forEach((scoreData, periodIndex) => {
            if (scoreData.total_trades > 0) {
                const x = margin.left + (periodIndex / Math.max(periods.length - 1, 1)) * chartWidth;
                const y = margin.top + chartHeight - (scoreData.total_score / 30) * chartHeight;
                
                if (!hasValidPoint) {
                    ctx.moveTo(x, y);
                    hasValidPoint = true;
                } else {
                    ctx.lineTo(x, y);
                }
            }
        });
        
        if (hasValidPoint) {
            ctx.stroke();
            
            // 绘制数据点
            strategy.scores.forEach((scoreData, periodIndex) => {
                if (scoreData.total_trades > 0) {
                    const x = margin.left + (periodIndex / Math.max(periods.length - 1, 1)) * chartWidth;
                    const y = margin.top + chartHeight - (scoreData.total_score / 30) * chartHeight;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }
    });
    
    // 绘制图例
    const legendX = margin.left + chartWidth + 20;
    let legendY = margin.top;
    
    ctx.font = '14px Arial';
    ctx.textAlign = 'left';
    strategies.forEach((strategy, index) => {
        const color = colors[index % colors.length];
        const y = legendY + index * 25;
        
        // 图例颜色方块
        ctx.fillStyle = color;
        ctx.fillRect(legendX, y - 8, 12, 12);
        
        // 图例文字
        ctx.fillStyle = '#495057';
        ctx.fillText(strategy.name, legendX + 20, y + 2);
    });
    
    // 图表标题
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#495057';
    ctx.fillText('策略总分趋势变化', canvas.width / 2, 25);
    
    // Y轴标题
    ctx.save();
    ctx.translate(20, canvas.height / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('策略得分', 0, 0);
    ctx.restore();
}

function changePeriodType() {
    const periodType = document.getElementById('periodTypeSelect').value;
    window.location.href = `{{ url_for('analysis.time_comparison') }}?period_type=${periodType}`;
}
</script>
{% endblock %}