{% extends "base.html" %}
{% block title %}首页 - 多策略系统分析{% endblock %}
{% block content %}
    <!-- 策略选择器 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-funnel"></i> 策略筛选
                    </h6>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for("main.index") }}?strategy=all"
                           class="btn {{ 'btn-primary' if stats.selected_strategy == 'all' else 'btn-outline-primary' }}">
                            全部策略
                        </a>
                        {% for strategy_code, strategy_name in strategies.items() %}
                            <a href="{{ url_for("main.index") }}?strategy={{ strategy_code }}"
                               class="btn {{ 'btn-primary' if stats.selected_strategy == strategy_code else 'btn-outline-primary' }}">
                                {{ strategy_name }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-speedometer2"></i> 交易概览
                        {% if stats.selected_strategy != 'all' %}
                            <span class="badge bg-secondary ms-2">{{ strategies[stats.selected_strategy] }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card bg-primary text-white h-100">
                                <div class="card-body text-center">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="fw-bold" id="totalTrades">-</h4>
                                            <span>总交易数</span>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-receipt" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card bg-success text-white h-100">
                                <div class="card-body text-center">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="fw-bold" id="openTrades">-</h4>
                                            <span>持仓中</span>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-clock" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card bg-info text-white h-100">
                                <div class="card-body text-center">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="fw-bold" id="closedTrades">-</h4>
                                            <span>已平仓</span>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card bg-warning text-white h-100">
                                <div class="card-body text-center">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h4 class="fw-bold" id="totalProfitLoss">-</h4>
                                            <span>总净利润</span>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="bi bi-currency-dollar" style="font-size: 2rem;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> 盈亏趋势图
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="profitChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart"></i> 胜负分布
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="winLossChart" width="200" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> 最近交易
                    </h5>
                    <a href="{{ url_for('trading.trades') }}"
                       class="btn btn-outline-primary btn-sm">
                        查看全部 <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="recentTradesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>策略</th>
                                    <th>标的代码</th>
                                    <th>标的名称</th>
                                    <th>开仓日期</th>
                                    <th>平仓日期</th>
                                    <th>状态</th>
                                    <th>持仓/剩余数量</th>
                                    <th>总买入金额</th>
                                    <th>总卖出金额</th>
                                    <th>总净利润</th>
                                    <th>总净利率</th>
                                    <th>总买入费用</th>
                                    <th>总卖出费用</th>
                                    <th>总毛利润</th>
                                    <th>总毛利率</th>
                                    <th>总交易费用</th>
                                    <th>总费用占比</th>
                                    <th>持仓天数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if stats.recent_trades %}
                                    {% for trade in stats.recent_trades %}
                                        <tr>
                                            <td>{{ trade.id }}</td>
                                            <td>
                                                <span class="badge bg-primary">{{ trade.strategy_name or '-' }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ trade.symbol_code }}</span>
                                            </td>
                                            <td>{{ trade.symbol_name }}</td>
                                            <td>{{ trade.open_date }}</td>
                                            <td>
                                                {% if trade.close_date %}
                                                    {{ trade.close_date }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if trade.status == 'open' %}
                                                    <span class="badge bg-success">持仓中</span>
                                                {% else %}
                                                    <span class="badge bg-info">已平仓</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if trade.status == 'open' %}
                                                    <span class="text-primary fw-bold">{{ trade.remaining_quantity }}</span>
                                                {% else %}
                                                    <span class="text-muted">{{ trade.total_buy_quantity }}</span>
                                                {% endif %}
                                            </td>
                                            <td>¥{{ "%.3f"|format(trade.total_buy_amount) }}</td>
                                            <td>¥{{ "%.3f"|format(trade.total_sell_amount) }}</td>
                                            <td>
                                                {% if trade.total_net_profit > 0 %}
                                                    <span class="text-danger fw-bold">+¥{{ "%.3f"|format(trade.total_net_profit) }}</span>
                                                {% elif trade.total_net_profit < 0 %}
                                                    <span class="text-success fw-bold">-¥{{ "%.3f"|format((trade.total_net_profit | abs) ) }}</span>
                                                {% else %}
                                                    <span class="text-muted">¥0.000</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if trade.total_net_profit_pct > 0 %}
                                                    <span class="text-danger fw-bold">+{{ "%.2f"|format(trade.total_net_profit_pct) }}%</span>
                                                {% elif trade.total_net_profit_pct < 0 %}
                                                    <span class="text-success fw-bold">{{ "%.2f"|format(trade.total_net_profit_pct) }}%</span>
                                                {% else %}
                                                    <span class="text-muted">0.00%</span>
                                                {% endif %}
                                            </td>
                                            <td>¥{{ "%.3f"|format(trade.total_buy_fees) }}</td>
                                            <td>¥{{ "%.3f"|format(trade.total_sell_fees) }}</td>
                                            <td>
                                                {% if trade.total_profit_loss > 0 %}
                                                    <span class="text-danger fw-bold">+¥{{ "%.3f"|format(trade.total_profit_loss) }}</span>
                                                {% elif trade.total_profit_loss < 0 %}
                                                    <span class="text-success fw-bold">-¥{{ "%.3f"|format((trade.total_profit_loss | abs) ) }}</span>
                                                {% else %}
                                                    <span class="text-muted">¥0.000</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if trade.total_profit_loss_pct > 0 %}
                                                    <span class="text-danger fw-bold">+{{ "%.2f"|format(trade.total_profit_loss_pct) }}%</span>
                                                {% elif trade.total_profit_loss_pct < 0 %}
                                                    <span class="text-success fw-bold">{{ "%.2f"|format(trade.total_profit_loss_pct) }}%</span>
                                                {% else %}
                                                    <span class="text-muted">0.00%</span>
                                                {% endif %}
                                            </td>
                                            <td>¥{{ "%.3f"|format(trade.total_fees) }}</td>
                                            <td>{{ "%.2f"|format(trade.total_fee_ratio_pct) }}%</td>
                                            <td>
                                                {% if trade.holding_days %}
                                                    {{ trade.holding_days }}天
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('trading.trade_details', trade_id=trade.id) }}"
                                                   class="btn btn-outline-info btn-sm">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                {% if trade.status == 'open' and trade.remaining_quantity > 0 %}
                                                    <a href="{{ url_for('trading.add_sell', trade_id=trade.id) }}"
                                                       class="btn btn-outline-warning btn-sm">
                                                        <i class="bi bi-dash-circle"></i>
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> 暂无交易记录
                                            <br>
                                            <a href="{{ url_for('trading.add_buy') }}"
                                               class="btn btn-success btn-sm mt-2">
                                                <i class="bi bi-plus-circle"></i> 创建第一笔交易
                                            </a>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning"></i> 快速操作
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="dropdown">
                                <button class="btn btn-success btn-lg w-100 dropdown-toggle"
                                        type="button"
                                        data-bs-toggle="dropdown">
                                    <i class="bi bi-plus-circle"></i>
                                    <br>
                                    新建买入交易
                                </button>
                                <ul class="dropdown-menu w-100">
                                    {% for strategy_code, strategy_name in strategies.items() %}
                                        <li>
                                            <a class="dropdown-item"
                                               href="{{ url_for('trading.add_buy') }}?strategy={{ strategy_code }}">{{ strategy_name }}</a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('trading.trades') }}?status=open{% if stats.selected_strategy != 'all' %}&strategy={{ stats.selected_strategy }}{% endif %}"
                               class="btn btn-info btn-lg w-100">
                                <i class="bi bi-list-check"></i>
                                <br>
                                管理持仓
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('trading.trades') }}{% if stats.selected_strategy != 'all' %}?strategy={{ stats.selected_strategy }}{% endif %}"
                               class="btn btn-warning btn-lg w-100">
                                <i class="bi bi-bar-chart-line"></i>
                                <br>
                                查看交易记录
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('analysis.strategy_scores') }}"
                               class="btn btn-success btn-lg w-100">
                                <i class="bi bi-award"></i>
                                <br>
                                策略评分
                            </a>
                        </div>
                    </div>
                    <!-- 第二行快捷操作 -->
                    <div class="row">
						<div class="col-md-3 mb-3">
                            <a href="{{ url_for('strategy.strategies') }}"
                               class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-diagram-3"></i>
                                <br>
                                策略管理
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('strategy.create_strategy') }}"
                               class="btn btn-outline-primary btn-lg w-100">
                                <i class="bi bi-plus-square"></i>
                                <br>
                                新建策略
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('trading.deleted_trades') }}"
                               class="btn btn-outline-secondary btn-lg w-100">
                                <i class="bi bi-trash"></i>
                                <br>
                                已删除记录
                            </a>
                        </div>
						<div class="col-md-3 mb-3">
							<a href="{{ url_for('admin.db_diagnose_page') }}"
							   class="btn btn-outline-dark btn-lg w-100">
								<i class="bi bi-hdd-network"></i>
								<br>
								数据库管理
							</a>
						</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 策略对比 -->
    <div class="row mt-4" id="strategy-comparison">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up-arrow"></i> 策略对比
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for strategy_code, strategy_data in stats.strategy_stats.items() %}
                            {% set strategy_colors = ["primary", "success", "warning", "info", "secondary", "danger"] %}
                            {% set color_index = loop.index0 % strategy_colors|length %}
                            {% set color = strategy_colors[color_index] %}
                            <div class="col-md-3 mb-3">
                                <div class="card h-100 border-{{ color }}">
                                    <div class="card-header text-center bg-{{ color }} {{ 'text-white' if color != 'warning' else 'text-dark' }}">
                                        <h6 class="card-title mb-0">{{ strategy_data.name }}</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="row">
                                            <div class="col-6">
                                                <h4 class="text-primary">{{ strategy_data.total_trades }}</h4>
                                                <small class="text-muted">交易数</small>
                                            </div>
                                            <div class="col-6">
                                                {% if strategy_data.total_profit_loss > 0 %}
                                                    <h4 class="text-danger">+¥{{ "%.2f"|format(strategy_data.total_profit_loss) }}</h4>
                                                {% elif strategy_data.total_profit_loss < 0 %}
                                                    <h4 class="text-success">-¥{{ "%.2f"|format((strategy_data.total_profit_loss | abs) ) }}</h4>
                                                {% else %}
                                                    <h4 class="text-muted">¥0.00</h4>
                                                {% endif %}
                                                <small class="text-muted">总净利润</small>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <a href="{{ url_for("main.index") }}?strategy={{ strategy_code }}"
                                               class="btn btn-outline-primary btn-sm me-2">
                                                <i class="bi bi-eye"></i> 查看详情
                                            </a>
                                            <a href="{{ url_for('trading.add_buy') }}?strategy={{ strategy_code }}"
                                               class="btn btn-outline-success btn-sm">
                                                <i class="bi bi-plus"></i> 新建交易
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

function loadDashboardData() {
    // 使用服务器端传递的数据更新统计卡片
    {% if stats %}
    document.getElementById('totalTrades').textContent = '{{ stats.total_trades }}';
    document.getElementById('openTrades').textContent = '{{ stats.open_trades }}';
    document.getElementById('closedTrades').textContent = '{{ stats.closed_trades }}';
    
    // 格式化总净利润显示
    const totalProfitLoss = {{ stats.total_net_profit|default(0.0) }};
    const profitLossElement = document.getElementById('totalProfitLoss');
    if (totalProfitLoss > 0) {
        profitLossElement.textContent = '+¥' + totalProfitLoss.toFixed(3);
        profitLossElement.className = 'fw-bold text-danger';
    } else if (totalProfitLoss < 0) {
        profitLossElement.textContent = '-¥' + Math.abs(totalProfitLoss).toFixed(3);
        profitLossElement.className = 'fw-bold text-success';
    } else {
        profitLossElement.textContent = '¥0.000';
        profitLossElement.className = 'fw-bold text-muted';
    }
    {% else %}
    document.getElementById('totalTrades').textContent = '0';
    document.getElementById('openTrades').textContent = '0';
    document.getElementById('closedTrades').textContent = '0';
    document.getElementById('totalProfitLoss').textContent = '¥0.000';
    {% endif %}
    
    // 初始化图表
    initProfitChart();
    initWinLossChart();
}

function initProfitChart() {
    const ctx = document.getElementById('profitChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '累计盈亏',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '累计盈亏趋势'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initWinLossChart() {
    const ctx = document.getElementById('winLossChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['盈利', '亏损'],
            datasets: [{
                data: [0, 0],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: '盈亏分布'
                }
            }
        }
    });
}

// loadRecentTrades函数已经不需要了，因为数据现在通过服务器端模板渲染
    </script>
{% endblock %}
