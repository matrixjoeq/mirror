{% extends "base.html" %}
{% block title %}{{ symbol_name }} - ç­–ç•¥æ¯”è¾ƒ{% endblock %}
{% block content %}
    <!-- æ ‡çš„æ€»ä½“ä¿¡æ¯ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-diagram-2"></i> {{ symbol_code }} - {{ symbol_name }} ç­–ç•¥æ¯”è¾ƒ
                        <a href="{{ url_for("analysis.symbol_comparison") }}"
                           class="btn btn-outline-secondary btn-sm float-end">
                            <i class="bi bi-arrow-left"></i> è¿”å›æ ‡çš„åˆ—è¡¨
                        </a>
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        æ¨ªå‘æ¯”è¾ƒä¸åŒç­–ç•¥åœ¨ <strong>{{ symbol_name }} ({{ symbol_code }})</strong> ä¸Šçš„è¡¨ç°ï¼Œ
                        å¸®åŠ©æ‚¨é€‰æ‹©æœ€é€‚åˆè¯¥æ ‡çš„çš„äº¤æ˜“ç­–ç•¥ã€‚
                    </p>
                    <!-- ç­–ç•¥è¯„åˆ†æ¦‚è§ˆ -->
                    {% set best_strategy = strategy_scores | selectattr('stats', 'defined') | sort(attribute='stats.win_rate', reverse=true) | first %}
                    <div class="row">
                        {% for score in strategy_scores %}
                            {% set icon = "graph-up" %}
                            {% set color = "secondary" %}
                            {% if 'è¶‹åŠ¿' in score.strategy_name %}
                                {% set icon = "graph-up" %}
                                {% set color = "primary" %}
                            {% elif 'è½®åŠ¨' in score.strategy_name %}
                                {% set icon = "arrow-repeat" %}
                                {% set color = "success" %}
                            {% elif 'ç½‘æ ¼' in score.strategy_name %}
                                {% set icon = "grid" %}
                                {% set color = "warning" %}
                            {% elif 'å¥—åˆ©' in score.strategy_name %}
                                {% set icon = "diagram-3" %}
                                {% set color = "info" %}
                            {% endif %}
                            <div class="col-md-3 col-sm-6 text-center mb-3">
                                <div class="card border-{{ color }} {% if best_strategy and score.strategy_id == best_strategy.strategy_id %}border-3{% endif %} position-relative">
                                    {% if best_strategy and score.strategy_id == best_strategy.strategy_id %}
                                        <div class="position-absolute top-0 start-50 translate-middle">
                                            <span class="badge bg-warning text-dark best-strategy-badge">ğŸ† æœ€ä½³</span>
                                        </div>
                                    {% endif %}
                                    <div class="card-body p-2 pt-3">
                                        <i class="bi bi-{{ icon }} text-{{ color }} fs-4"></i>
                                        <div class="small">{{ score.strategy_name }}</div>
                                        {% set _ws = score.win_rate_score %}
                                        {% set _plrs = score.profit_loss_ratio_score %}
                                        {% set _fs = score.frequency_score %}
                                        {% set _total = score.total_score %}
                                        <div class="h5 mb-1 {% if _total >= 23 %}text-success {% elif _total >= 20 %}text-info {% elif _total >= 18 %}text-warning {% else %}text-danger{% endif %}">
                                            {{ '%.1f'|format(_total) }}åˆ†
                                        </div>
                                        {% set _rating = "D" %}
                                        {% if _total >= 26 %}
                                            {% set _rating = "A+" %}
                                        {% elif _total >= 23 %}
                                            {% set _rating = "A" %}
                                        {% elif _total >= 20 %}
                                            {% set _rating = "B" %}
                                        {% elif _total >= 18 %}
                                            {% set _rating = "C" %}
                                        {% endif %}
                                        <div class="badge {% if _total >= 26 %}bg-primary {% elif _total >= 23 %}bg-success {% elif _total >= 20 %}bg-info {% elif _total >= 18 %}bg-warning {% else %}bg-danger{% endif %}">
                                            {{ _rating }}
                                        </div>
                                        {% if best_strategy and score.strategy_id == best_strategy.strategy_id %}
                                            <div class="mt-2">
                                                <small class="text-muted">äº¤æ˜“: {{ score.stats.total_trades }}ç¬” | èƒœç‡: {{ score.stats.win_rate }}%</small>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ç­–ç•¥è¯¦ç»†æ¯”è¾ƒ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-table"></i> ç­–ç•¥è¯¦ç»†æ¯”è¾ƒ
                    </h6>
                </div>
                <div class="card-body">
                    {% if strategy_scores %}
                        <!-- æ’åºæ§åˆ¶ -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">æ’åºæ–¹å¼:</label>
                                <select class="form-select form-select-sm"
                                        id="sortSelect"
                                        onchange="updateSort()">
                                    <option value="total_score" {{ 'selected' if sort_by == 'total_score' else '' }}>æ€»åˆ†
                                    </option>
                                    <option value="win_rate" {{ 'selected' if sort_by == 'win_rate' else '' }}>èƒœç‡
                                    </option>
                                    <option value="avg_profit_loss_ratio" {{ 'selected' if sort_by == 'avg_profit_loss_ratio' else '' }}>ç›ˆäºæ¯”
                                    </option>
                                    <option value="avg_holding_days" {{ 'selected' if sort_by == 'avg_holding_days' else '' }}>æŒä»“å¤©æ•°
                                    </option>
                                    <option value="strategy_code" {{ 'selected' if sort_by == 'strategy_code' else '' }}>ç­–ç•¥åç§°
                                    </option>
                                    <option value="win_rate" {{ 'selected' if sort_by == 'win_rate' else '' }}>èƒœç‡
                                    </option>
                                    <option value="avg_profit_loss_ratio" {{ 'selected' if sort_by == 'avg_profit_loss_ratio' else '' }}>ç›ˆäºæ¯”
                                    </option>
                                    <option value="avg_holding_days" {{ 'selected' if sort_by == 'avg_holding_days' else '' }}>æŒä»“å¤©æ•°
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">æ’åºé¡ºåº:</label>
                                <select class="form-select form-select-sm"
                                        id="orderSelect"
                                        onchange="updateSort()">
                                    <option value="desc" {{ 'selected' if sort_order == 'desc' else '' }}>é™åº
                                    </option>
                                    <option value="asc" {{ 'selected' if sort_order == 'asc' else '' }}>å‡åº
                                    </option>
                                </select>
                            </div>
                        </div>
                        <!-- è¡¨æ ¼ -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ç­–ç•¥</th>
                                        <th>æ€»åˆ†</th>
                                        <th>è¯„çº§</th>
                                        <th>èƒœç‡å¾—åˆ†</th>
                                        <th>ç›ˆäºæ¯”å¾—åˆ†</th>
                                        <th>é¢‘ç‡å¾—åˆ†</th>
                                        <th>äº¤æ˜“æ•°</th>
                                        <th>èƒœç‡</th>
                                        <th>ç›ˆäºæ¯”</th>
                                        <th>æŒä»“å¤©æ•°</th>
                                        <th>äº¤æ˜“è´¹ç”¨</th>
                                        <th>è´¹ç”¨å æ¯”</th>
                                        <th>ä¸‰è§’å›¾</th>
                                        <th>æ¨èåº¦</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for score in strategy_scores %}
                                        <tr class="{% if loop.index == 1 %}table-success{% endif %}">
                                            <td>
                                                {% set icon = "graph-up" %}
                                                {% set color = "secondary" %}
                                                {% if 'è¶‹åŠ¿' in score.strategy_name %}
                                                    {% set icon = "graph-up" %}
                                                    {% set color = "primary" %}
                                                {% elif 'è½®åŠ¨' in score.strategy_name %}
                                                    {% set icon = "arrow-repeat" %}
                                                    {% set color = "success" %}
                                                {% elif 'ç½‘æ ¼' in score.strategy_name %}
                                                    {% set icon = "grid" %}
                                                    {% set color = "warning" %}
                                                {% elif 'å¥—åˆ©' in score.strategy_name %}
                                                    {% set icon = "diagram-3" %}
                                                    {% set color = "info" %}
                                                {% endif %}
                                                <i class="bi bi-{{ icon }} text-{{ color }}"></i>
                                                <strong>{{ score.strategy_name }}</strong>
                                            </td>
                                            <td>
                                                {% set _ws = score.win_rate_score %}
                                                {% set _pl = score.profit_loss_ratio_score %}
                                                {% set _fs = score.frequency_score %}
                                                {% set _tot = score.total_score %}
                                                <span class="badge {% if _tot >= 26 %}bg-primary {% elif _tot >= 23 %}bg-success {% elif _tot >= 20 %}bg-info {% elif _tot >= 18 %}bg-warning {% else %}bg-danger{% endif %}">
                                                    {{ '%.1f'|format(_tot) }}åˆ†
                                                </span>
                                            </td>
                                            <td>
                                                {% set _rating = "D" %}
                                                {% if _tot >= 26 %}
                                                    {% set _rating = "A+" %}
                                                {% elif _tot >= 23 %}
                                                    {% set _rating = "A" %}
                                                {% elif _tot >= 20 %}
                                                    {% set _rating = "B" %}
                                                {% elif _tot >= 18 %}
                                                    {% set _rating = "C" %}
                                                {% endif %}
                                                {{ _rating }}
                                            </td>
                                            <td>{{ '%.1f'|format(_ws) }}</td>
                                            <td>{{ '%.1f'|format(_pl) }}</td>
                                            <td>{{ '%.1f'|format(_fs) }}</td>
                                            <td>{{ score.stats.total_trades }}</td>
                                            <td>{{ score.stats.win_rate }}%</td>
                                            <td>{{ score.stats.avg_profit_loss_ratio }}:1</td>
                                            <td>{{ score.stats.avg_holding_days }}</td>
                                            <td>{{ score.stats.total_transaction_fees }}</td>
                                            <td>{{ score.stats.total_fee_ratio }}%</td>
                                            <td>
                                                <canvas id="triangle-{{ score.strategy_id }}" width="80" height="70"></canvas>
                                            </td>
                                            <td>
                                                {% if loop.index == 1 %}
                                                    <span class="badge bg-success">ğŸ‘‘ æœ€ä½³</span>
                                                {% elif _tot >= 20 %}
                                                    <span class="badge bg-info">æ¨è</span>
                                                {% elif _tot >= 18 %}
                                                    <span class="badge bg-warning">å¯è€ƒè™‘</span>
                                                {% else %}
                                                    <span class="badge bg-danger">ä¸å»ºè®®</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                            <h5>æš‚æ— æ•°æ®</h5>
                            <p>è¯¥æ ‡çš„è¿˜æ²¡æœ‰å·²å¹³ä»“çš„äº¤æ˜“è®°å½•</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- ç­–ç•¥åˆ†æå»ºè®® -->
    {% if strategy_scores %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="bi bi-lightbulb"></i> ç­–ç•¥åˆ†æå»ºè®®
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>è¡¨ç°åˆ†æ</h6>
                                {% set best = strategy_scores[0] %}
                                {% set worst = strategy_scores[-1] %}
                                {% set best_ws = (best.stats.win_rate or 0) / 10 %}
                                {% set best_pl = (best.stats.avg_profit_loss_ratio == 9999.0 and 10) or (best.stats.avg_profit_loss_ratio or 0) %}
                                {% if best_pl > 10 %}
                                    {% set best_pl = 10 %}
                                {% endif %}
                                {% set best_fs = (best.stats.total_trades == 0 and 0) or (best.stats.avg_holding_days <= 1 and 8) or (best.stats.avg_holding_days <= 7 and 7) or (best.stats.avg_holding_days <= 30 and 6) or (6 - ((best.stats.avg_holding_days or 0) - 30) / 30) %}
                                {% set best_tot = best_ws + best_pl + best_fs %}
                                {% set worst_ws = (worst.stats.win_rate or 0) / 10 %}
                                {% set worst_pl = (worst.stats.avg_profit_loss_ratio == 9999.0 and 10) or (worst.stats.avg_profit_loss_ratio or 0) %}
                                {% if worst_pl > 10 %}
                                    {% set worst_pl = 10 %}
                                {% endif %}
                                {% set worst_fs = (worst.stats.total_trades == 0 and 0) or (worst.stats.avg_holding_days <= 1 and 8) or (worst.stats.avg_holding_days <= 7 and 7) or (worst.stats.avg_holding_days <= 30 and 6) or (6 - ((worst.stats.avg_holding_days or 0) - 30) / 30) %}
                                {% set worst_tot = worst_ws + worst_pl + worst_fs %}
                                <ul class="small">
                                    <li>
                                        <strong>æœ€ä½³ç­–ç•¥</strong>ï¼š{{ best.strategy_name }} ({{ '%.1f'|format(best_tot) }}åˆ†)
                                    </li>
                                    {% if best_tot >= 23 %}
                                        <li class="text-success">è¯¥ç­–ç•¥åœ¨æ­¤æ ‡çš„ä¸Šè¡¨ç°ä¼˜ç§€ï¼Œå»ºè®®é‡ç‚¹ä½¿ç”¨</li>
                                    {% elif best_tot >= 18 %}
                                        <li class="text-info">è¯¥ç­–ç•¥åœ¨æ­¤æ ‡çš„ä¸Šè¡¨ç°åˆæ ¼ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨</li>
                                    {% else %}
                                        <li class="text-warning">æ‰€æœ‰ç­–ç•¥åœ¨æ­¤æ ‡çš„ä¸Šè¡¨ç°ä¸€èˆ¬ï¼Œéœ€è¦è°¨æ…</li>
                                    {% endif %}
                                    <li>
                                        <strong>å¾…æ”¹è¿›ç­–ç•¥</strong>ï¼š{{ worst.strategy_name }} ({{ '%.1f'|format(worst_tot) }}åˆ†)
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>æŠ•èµ„å»ºè®®</h6>
                                <ul class="small">
                                    {% if best_tot >= 23 %}<li class="text-success">å»ºè®®ä¼˜å…ˆä½¿ç”¨ {{ best.strategy_name }} è¿›è¡Œäº¤æ˜“</li>{% endif %}
                                    {% set good_count = 0 %}
                                    {% for s in strategy_scores %}
                                        {% set __ws = (s.stats.win_rate or 0)/10 %}
                                        {% set __pl = (s.stats.avg_profit_loss_ratio == 9999.0 and 10) or (s.stats.avg_profit_loss_ratio or 0) %}
                                        {% if __pl > 10 %}
                                            {% set __pl = 10 %}
                                        {% endif %}
                                        {% set __fs = (s.stats.total_trades == 0 and 0) or (s.stats.avg_holding_days <= 1 and 8) or (s.stats.avg_holding_days <= 7 and 7) or (s.stats.avg_holding_days <= 30 and 6) or (6 - ((s.stats.avg_holding_days or 0) - 30) / 30) %}
                                        {% set __tot = __ws + __pl + __fs %}
                                        {% if __tot >= 20 %}
                                            {% set good_count = good_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if good_count > 1 %}<li class="text-info">å¯è€ƒè™‘ç»„åˆä½¿ç”¨å¤šä¸ªä¼˜ç§€ç­–ç•¥åˆ†æ•£é£é™©</li>{% endif %}
                                    {% if best_ws < 6 %}<li class="text-warning">æ³¨æ„æ§åˆ¶èƒœç‡ï¼Œå»ºè®®ä¼˜åŒ–å…¥åœºæ—¶æœº</li>{% endif %}
                                    {% if best_pl < 6 %}<li class="text-warning">æ³¨æ„ä¼˜åŒ–ç›ˆäºæ¯”ï¼Œå»ºè®®è°ƒæ•´æ­¢ç›ˆæ­¢æŸç‚¹</li>{% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block scripts %}
    <script>
document.addEventListener('DOMContentLoaded', function() {
    // ç»˜åˆ¶å„ç­–ç•¥çš„å°ä¸‰è§’å›¾
    {% for score in strategy_scores %}
    drawTriangleScore('triangle-{{ score.strategy_id }}', 
                     {{ (score.stats.win_rate or 0) / 10 }}, 
                     {{ ((score.stats.avg_profit_loss_ratio == 9999.0 and 10) or (score.stats.avg_profit_loss_ratio or 0)) }}, 
                     {{ (score.stats.total_trades == 0 and 0) or (score.stats.avg_holding_days <= 1 and 8) or (score.stats.avg_holding_days <= 7 and 7) or (score.stats.avg_holding_days <= 30 and 6) or (6 - ((score.stats.avg_holding_days or 0) - 30) / 30) }}, 
                     false);
    {% endfor %}
});

function drawTriangleScore(canvasId, winRate, profitRatio, frequency, showLabels = false) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = (canvas.height / 2) + (showLabels ? 15 : 0);
    const radius = showLabels ? 65 : 25;
    
    // æ¸…é™¤ç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ä¸‰è§’å½¢é¡¶ç‚¹åæ ‡
    const points = [
        { x: centerX, y: centerY - radius, label: 'èƒœç‡' },
        { x: centerX - radius * Math.sin(Math.PI / 3), y: centerY + radius * Math.cos(Math.PI / 3), label: 'ç›ˆäºæ¯”' },
        { x: centerX + radius * Math.sin(Math.PI / 3), y: centerY + radius * Math.cos(Math.PI / 3), label: 'é¢‘ç‡' }
    ];
    
    // ç»˜åˆ¶å¤–æ¡†ä¸‰è§’å½¢
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    ctx.lineTo(points[1].x, points[1].y);
    ctx.lineTo(points[2].x, points[2].y);
    ctx.closePath();
    ctx.strokeStyle = '#dee2e6';
    ctx.lineWidth = showLabels ? 2 : 1;
    ctx.stroke();
    
    // è®¡ç®—æ•°æ®ç‚¹ä½ç½®
    const maxScore = [10, 10, 8];
    const scores = [winRate, profitRatio, frequency];
    const ratios = scores.map((score, i) => score / maxScore[i]);
    
    // ç»˜åˆ¶æ•°æ®ä¸‰è§’å½¢
    ctx.beginPath();
    ctx.moveTo(
        centerX + (points[0].x - centerX) * ratios[0],
        centerY + (points[0].y - centerY) * ratios[0]
    );
    ctx.lineTo(
        centerX + (points[1].x - centerX) * ratios[1],
        centerY + (points[1].y - centerY) * ratios[1]
    );
    ctx.lineTo(
        centerX + (points[2].x - centerX) * ratios[2],
        centerY + (points[2].y - centerY) * ratios[2]
    );
    ctx.closePath();
    ctx.fillStyle = 'rgba(13, 110, 253, 0.3)';
    ctx.fill();
    ctx.strokeStyle = '#0d6efd';
    ctx.lineWidth = showLabels ? 2 : 1;
    ctx.stroke();
    
    // ç»˜åˆ¶æ•°æ®ç‚¹
    scores.forEach((score, i) => {
        const ratio = ratios[i];
        const x = centerX + (points[i].x - centerX) * ratio;
        const y = centerY + (points[i].y - centerY) * ratio;
        
        ctx.beginPath();
        ctx.arc(x, y, showLabels ? 4 : 2, 0, 2 * Math.PI);
        ctx.fillStyle = '#0d6efd';
        ctx.fill();
    });
}

function updateSort() {
    const sortBy = document.getElementById('sortSelect').value;
    const order = document.getElementById('orderSelect').value;
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.set('order', order);
    window.location.href = url.toString();
}
    </script>
{% endblock %}
