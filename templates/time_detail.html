{% extends "base.html" %}

{% block title %}{{ period }} - ç­–ç•¥æ¯”è¾ƒ{% endblock %}

{% block content %}
<!-- æ—¶é—´æ®µæ€»ä½“ä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-week"></i> 
                    {% if period_type == 'year' %}
                    {{ period }}å¹´ - ç­–ç•¥æ¯”è¾ƒ
                    {% elif period_type == 'quarter' %}
                    {{ period }} - ç­–ç•¥æ¯”è¾ƒ
                    {% else %}
                    {{ period }} - ç­–ç•¥æ¯”è¾ƒ
                    {% endif %}
                    <a href="{{ url_for('analysis.time_comparison', period_type=period_type) }}" class="btn btn-outline-secondary btn-sm float-end">
                        <i class="bi bi-arrow-left"></i> è¿”å›æ—¶é—´æ®µåˆ—è¡¨
                    </a>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="text-muted">
                            åˆ†æä¸åŒç­–ç•¥åœ¨ 
                            {% if period_type == 'year' %}
                            <strong>{{ period }}å¹´</strong>
                            {% elif period_type == 'quarter' %}
                            <strong>{{ period }}</strong>
                            {% else %}
                            <strong>{{ period }}</strong>
                            {% endif %}
                            æœŸé—´çš„è¡¨ç°å·®å¼‚ï¼Œè¯†åˆ«æœ€é€‚åˆè¯¥æ—¶æœŸçš„äº¤æ˜“ç­–ç•¥ã€‚
                        </p>
                            <div class="small text-muted">
                                æ—¶é—´èŒƒå›´: {{ start_date }} è‡³ {{ end_date }}
                            </div>
                        
                        <!-- æ—¶é—´æ®µæ€»ä½“ç»Ÿè®¡ -->
                        {% if period_summary %}
                        <div class="mt-3">
                            <div class="bg-light rounded p-3">
                                <h6 class="text-primary mb-3">ğŸ“Š æœŸé—´æ€»ä½“è¡¨ç°</h6>
                                <div class="row text-center">
                                    <div class="col-6 col-md-3 mb-2">
                                    <div class="h5 text-primary">{{ period_summary.stats.total_trades }}</div>
                                        <div class="small text-muted">æ€»äº¤æ˜“æ•°</div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-2">
                                    {% set ps_wr = period_summary.stats.win_rate or 0 %}
                                    <div class="h5 {% if ps_wr >= 60 %}text-success{% elif ps_wr >= 40 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ ps_wr }}%
                                        </div>
                                        <div class="small text-muted">èƒœç‡</div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-2">
                                        {% set ps_tr = period_summary.stats.total_return or 0 %}
                                        <div class="h5 {% if ps_tr > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(ps_tr) }}
                                        </div>
                                        <div class="small text-muted">æ€»ç›ˆäº</div>
                                    </div>
                                    <div class="col-6 col-md-3 mb-2">
                                        <div class="h5 text-info">{{ strategy_scores|length }}</div>
                                        <div class="small text-muted">æ¶‰åŠç­–ç•¥</div>
                                    </div>
                                </div>
                                
                                {% if period_summary.best_strategy %}
                                <div class="row mt-2">
                                    <div class="col-6">
                                        <div class="small">
                                            <span class="badge bg-success">ğŸ† æœ€ä½³ç­–ç•¥</span>
                                            <strong>{{ period_summary.best_strategy.name }}</strong>
                                            ({{ period_summary.best_strategy.score }}åˆ†)
                                        </div>
                                    </div>
                                    {% if period_summary.worst_strategy %}
                                    <div class="col-6">
                                        <div class="small">
                                            <span class="badge bg-warning">ğŸ“‰ å¾…æ”¹è¿›ç­–ç•¥</span>
                                            <strong>{{ period_summary.worst_strategy.name }}</strong>
                                            ({{ period_summary.worst_strategy.score }}åˆ†)
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- ç­–ç•¥è¯„åˆ†æ¦‚è§ˆ -->
                        <div class="row mt-3">
                            {% set colors = ['primary', 'success', 'warning', 'info', 'danger', 'secondary'] %}
                            {% set icons = ['graph-up', 'arrow-repeat', 'grid', 'diagram-3', 'bar-chart', 'gear'] %}
                            
                            {% for score in strategy_scores %}
                            {% set color_idx = loop.index0 % colors|length %}
                            {% set color = colors[color_idx] %}
                            {% set icon = icons[color_idx] %}
                            <div class="col-3 text-center mb-3">
                                <div class="card border-{{ color }}">
                                    <div class="card-body p-2">
                                        <i class="bi bi-{{ icon }} text-{{ color }} fs-4"></i>
                                        <div class="small">{{ score.strategy_name }}</div>
                                        {% set _ws = score.win_rate_score %}
                                        {% set _pl = score.profit_loss_ratio_score %}
                                        {% set _fs = score.frequency_score %}
                                        {% set _tot = score.total_score %}
                                        <div class="h5 mb-1 
                                            {% if _tot >= 23 %}text-success
                                            {% elif _tot >= 20 %}text-info
                                            {% elif _tot >= 18 %}text-warning
                                            {% else %}text-danger{% endif %}">
                                            {{ '%.1f'|format(_tot) }}åˆ†
                                        </div>
                                        {% set _rating = 'D' %}
                                        {% if _tot >= 26 %}{% set _rating = 'A+' %}
                                        {% elif _tot >= 23 %}{% set _rating = 'A' %}
                                        {% elif _tot >= 20 %}{% set _rating = 'B' %}
                                        {% elif _tot >= 18 %}{% set _rating = 'C' %}{% endif %}
                                        <div class="badge 
                                            {% if _tot >= 26 %}bg-primary
                                            {% elif _tot >= 23 %}bg-success
                                            {% elif _tot >= 20 %}bg-info
                                            {% elif _tot >= 18 %}bg-warning
                                            {% else %}bg-danger{% endif %}">{{ _rating }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <!-- æœ€ä½³ç­–ç•¥ä¸‰è§’å›¾ -->
                        {% set best_strategy = strategy_scores | selectattr('stats', 'defined') | sort(attribute='stats.win_rate', reverse=true) | first %}
                        {% if best_strategy %}
                        <h6 class="text-success">ğŸ† æœŸé—´æœ€ä½³ç­–ç•¥</h6>
                        <canvas id="best-triangle" width="180" height="160"></canvas>
                        <div class="mt-2">
                            <span class="badge bg-success">{{ best_strategy.strategy_name }}</span>
                            <div class="small text-muted mt-1">
                                äº¤æ˜“: {{ best_strategy.stats.total_trades }}ç¬” | 
                                èƒœç‡: {{ best_strategy.stats.win_rate }}%
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç­–ç•¥è¯¦ç»†æ¯”è¾ƒ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-table"></i> æœŸé—´ç­–ç•¥è¯¦ç»†æ¯”è¾ƒ
                </h6>
            </div>
            <div class="card-body">
                {% if strategy_scores %}
                <!-- æ’åºæ§åˆ¶ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">æ’åºæ–¹å¼:</label>
                        <select class="form-select form-select-sm" id="sortSelect" onchange="updateSort()">
                            <option value="total_score" {{ 'selected' if sort_by == 'total_score' else '' }}>æ€»åˆ†</option>
                            <option value="win_rate" {{ 'selected' if sort_by == 'win_rate' else '' }}>èƒœç‡</option>
                            <option value="avg_profit_loss_ratio" {{ 'selected' if sort_by == 'avg_profit_loss_ratio' else '' }}>ç›ˆäºæ¯”</option>
                            <option value="avg_holding_days" {{ 'selected' if sort_by == 'avg_holding_days' else '' }}>æŒä»“å¤©æ•°</option>
                            <option value="strategy_code" {{ 'selected' if sort_by == 'strategy_code' else '' }}>ç­–ç•¥åç§°</option>
                            <option value="win_rate" {{ 'selected' if sort_by == 'win_rate' else '' }}>èƒœç‡</option>
                            <option value="avg_profit_loss_ratio" {{ 'selected' if sort_by == 'avg_profit_loss_ratio' else '' }}>ç›ˆäºæ¯”</option>
                            <option value="avg_holding_days" {{ 'selected' if sort_by == 'avg_holding_days' else '' }}>æŒä»“å¤©æ•°</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">æ’åºé¡ºåº:</label>
                        <select class="form-select form-select-sm" id="orderSelect" onchange="updateSort()">
                            <option value="desc" {{ 'selected' if sort_order == 'desc' else '' }}>é™åº</option>
                            <option value="asc" {{ 'selected' if sort_order == 'asc' else '' }}>å‡åº</option>
                        </select>
                    </div>
                </div>
                
                <!-- è¡¨æ ¼ -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ç­–ç•¥</th>
                                <th>æ€»åˆ†</th>
                                <th>è¯„çº§</th>
                                <th>èƒœç‡å¾—åˆ†</th>
                                <th>ç›ˆäºæ¯”å¾—åˆ†</th>
                                <th>é¢‘ç‡å¾—åˆ†</th>
                                <th>äº¤æ˜“æ•°</th>
                                <th>èƒœç‡</th>
                                <th>ç›ˆäºæ¯”</th>
                                <th>æŒä»“å¤©æ•°</th>
                                <th>ä¸‰è§’å›¾</th>
                                <th>æœŸé—´è¡¨ç°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for score in strategy_scores %}
                            {% set color_idx = loop.index0 % colors|length %}
                            {% set color = colors[color_idx] %}
                            {% set icon = icons[color_idx] %}
                            <tr class="{% if loop.index == 1 %}table-success{% endif %}">
                                <td>
                                    <i class="bi bi-{{ icon }} text-{{ color }}"></i>
                                    <strong>{{ score.strategy_name }}</strong><br>
                                    <small class="text-muted">ID: {{ score.strategy_id }}</small>
                                    {% if score.strategy_tags %}
                                    <br><small class="text-muted">{{ score.strategy_tags|join(', ') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set _ws2 = score.win_rate_score %}
                                    {% set _pl2 = score.profit_loss_ratio_score %}
                                    {% set _fs2 = score.frequency_score %}
                                    {% set _tot2 = score.total_score %}
                                    <span class="badge 
                                        {% if _tot2 >= 26 %}bg-primary
                                        {% elif _tot2 >= 23 %}bg-success
                                        {% elif _tot2 >= 20 %}bg-info
                                        {% elif _tot2 >= 18 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ '%.1f'|format(_tot2) }}åˆ†
                                    </span>
                                </td>
                                <td>
                                    {% set _rt2 = 'D' %}
                                    {% if _tot2 >= 26 %}{% set _rt2 = 'A+' %}
                                    {% elif _tot2 >= 23 %}{% set _rt2 = 'A' %}
                                    {% elif _tot2 >= 20 %}{% set _rt2 = 'B' %}
                                    {% elif _tot2 >= 18 %}{% set _rt2 = 'C' %}{% endif %}
                                    {{ _rt2 }}
                                </td>
                                <td>{{ '%.1f'|format(_ws2) }}</td>
                                <td>{{ '%.1f'|format(_pl2) }}</td>
                                <td>{{ '%.1f'|format(_fs2) }}</td>
                                <td>{{ score.stats.total_trades }}</td>
                                <td>{{ score.stats.win_rate }}%</td>
                                <td>{{ score.stats.avg_profit_loss_ratio }}:1</td>
                                <td>{{ score.stats.avg_holding_days }}</td>
                                <td>
                                    <canvas id="triangle-{{ score.strategy_id }}" width="80" height="70"></canvas>
                                </td>
                                <td>
                                    {% if loop.index == 1 %}
                                    <span class="badge bg-success">ğŸ‘‘ æœ€ä½³</span>
                                    {% elif _tot2 >= 20 %}
                                    <span class="badge bg-info">ä¼˜ç§€</span>
                                    {% elif _tot2 >= 18 %}
                                    <span class="badge bg-warning">è‰¯å¥½</span>
                                    {% elif score.stats.total_trades > 0 %}
                                    <span class="badge bg-danger">ä¸€èˆ¬</span>
                                    {% else %}
                                    <span class="badge bg-secondary">æ— æ•°æ®</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <h5>æš‚æ— æ•°æ®</h5>
                    <p>è¯¥æ—¶é—´æ®µè¿˜æ²¡æœ‰å·²å¹³ä»“çš„äº¤æ˜“è®°å½•</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æœŸé—´ç­–ç•¥åˆ†æ -->
{% if strategy_scores %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-clipboard-data"></i> æœŸé—´ç­–ç•¥åˆ†æ
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>æœŸé—´ç‰¹å¾</h6>
                        {% set best = strategy_scores[0] %}
                        {% set worst = strategy_scores[-1] %}
                        {% set best_ws = (best.stats.win_rate or 0)/10 %}
                        {% set best_pl = (best.stats.avg_profit_loss_ratio == 9999.0 and 10) or (best.stats.avg_profit_loss_ratio or 0) %}
                        {% if best_pl > 10 %}{% set best_pl = 10 %}{% endif %}
                        {% set best_fs = (best.stats.total_trades == 0 and 0) or (best.stats.avg_holding_days <= 1 and 8) or (best.stats.avg_holding_days <= 7 and 7) or (best.stats.avg_holding_days <= 30 and 6) or (6 - ((best.stats.avg_holding_days or 0) - 30) / 30) %}
                        {% set best_tot = best_ws + best_pl + best_fs %}
                        {% set total_trades = strategy_scores | sum(attribute='stats.total_trades') %}
                        {% set active_strategies = strategy_scores | selectattr('stats.total_trades', '>', 0) | list %}
                        <ul class="small">
                            <li><strong>äº¤æ˜“æ´»è·ƒåº¦</strong>ï¼šå…±å®Œæˆ {{ total_trades }} ç¬”äº¤æ˜“</li>
                            <li><strong>ç­–ç•¥ä½¿ç”¨</strong>ï¼š{{ active_strategies | length }} ç§ç­–ç•¥å‚ä¸äº¤æ˜“</li>
                            <li><strong>æœ€ä½³ç­–ç•¥</strong>ï¼š{{ best.strategy_name }} ({{ '%.1f'|format(best_tot) }}åˆ†)</li>
                            {% if best.stats.total_trades > 0 %}
                            <li><strong>æœ€ä½³è¡¨ç°</strong>ï¼šèƒœç‡{{ best.stats.win_rate }}%ï¼Œç›ˆäºæ¯”{{ best.stats.avg_profit_loss_ratio }}:1</li>
                            {% endif %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>æ—¶æœŸå»ºè®®</h6>
                        <ul class="small">
                            {% if best_tot >= 23 %}
                            <li class="text-success">è¯¥æ—¶æœŸ{{ best.strategy_name }}è¡¨ç°å“è¶Šï¼Œå»ºè®®é‡ç‚¹ä½¿ç”¨</li>
                            {% elif best_tot >= 18 %}
                            <li class="text-info">è¯¥æ—¶æœŸç­–ç•¥è¡¨ç°è‰¯å¥½ï¼Œé€‚åˆæ­£å¸¸äº¤æ˜“</li>
                            {% else %}
                            <li class="text-warning">è¯¥æ—¶æœŸæ‰€æœ‰ç­–ç•¥è¡¨ç°ä¸€èˆ¬ï¼Œå»ºè®®è°¨æ…äº¤æ˜“</li>
                            {% endif %}
                            
                            {% if active_strategies | length >= 3 %}
                            <li class="text-info">å¤šç­–ç•¥å¹¶ç”¨ï¼Œé£é™©åˆ†æ•£æ•ˆæœè¾ƒå¥½</li>
                            {% elif active_strategies | length == 1 %}
                            <li class="text-warning">ä»…ä½¿ç”¨å•ä¸€ç­–ç•¥ï¼Œå»ºè®®å¢åŠ ç­–ç•¥å¤šæ ·æ€§</li>
                            {% endif %}
                            
                            {% set avg_score = (strategy_scores | map(attribute='stats.win_rate') | sum) / (strategy_scores | length) / 10 %}
                            {% if avg_score >= 20 %}
                            <li class="text-success">æ•´ä½“ç­–ç•¥ç¯å¢ƒè‰¯å¥½ï¼Œé€‚åˆç§¯æäº¤æ˜“</li>
                            {% elif avg_score >= 15 %}
                            <li class="text-info">ç­–ç•¥ç¯å¢ƒä¸­ç­‰ï¼Œå»ºè®®é€‚åº¦äº¤æ˜“</li>
                            {% else %}
                            <li class="text-warning">ç­–ç•¥ç¯å¢ƒè¾ƒå·®ï¼Œå»ºè®®ä¿å®ˆè§‚æœ›</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if best_strategy %}
    // ç»˜åˆ¶æœ€ä½³ç­–ç•¥ä¸‰è§’å›¾
    drawTriangleScore('best-triangle', 
                     {{ ((best_strategy.stats.win_rate or 0) / 10) or 0 }}, 
                     {{ (((best_strategy.stats.avg_profit_loss_ratio == 9999.0 and 10) or (best_strategy.stats.avg_profit_loss_ratio or 0)) or 0) }}, 
                     {{ ((best_strategy.stats.total_trades == 0 and 0) or (best_strategy.stats.avg_holding_days and (best_strategy.stats.avg_holding_days <= 1 and 8) or (best_strategy.stats.avg_holding_days <= 7 and 7) or (best_strategy.stats.avg_holding_days <= 30 and 6)) or (6 - (((best_strategy.stats.avg_holding_days or 0) - 30) / 30))) or 0 }}, 
                     false);
    {% endif %}
    
    // ç»˜åˆ¶å„ç­–ç•¥çš„å°ä¸‰è§’å›¾
    {% for score in strategy_scores %}
    drawTriangleScore('triangle-{{ score.strategy_id }}', 
                     {{ ((score.stats.win_rate or 0) / 10) or 0 }}, 
                     {{ (((score.stats.avg_profit_loss_ratio == 9999.0 and 10) or (score.stats.avg_profit_loss_ratio or 0)) or 0) }}, 
                     {{ ((score.stats.total_trades == 0 and 0) or (score.stats.avg_holding_days and (score.stats.avg_holding_days <= 1 and 8) or (score.stats.avg_holding_days <= 7 and 7) or (score.stats.avg_holding_days <= 30 and 6)) or (6 - (((score.stats.avg_holding_days or 0) - 30) / 30))) or 0 }}, 
                     false);
    {% endfor %}
});

function drawTriangleScore(canvasId, winRate, profitRatio, frequency, showLabels = false) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = (canvas.height / 2) + (showLabels ? 15 : 0);
    const radius = showLabels ? 65 : 25;
    
    // æ¸…é™¤ç”»å¸ƒ
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ä¸‰è§’å½¢é¡¶ç‚¹åæ ‡
    const points = [
        { x: centerX, y: centerY - radius, label: 'èƒœç‡' },
        { x: centerX - radius * Math.sin(Math.PI / 3), y: centerY + radius * Math.cos(Math.PI / 3), label: 'ç›ˆäºæ¯”' },
        { x: centerX + radius * Math.sin(Math.PI / 3), y: centerY + radius * Math.cos(Math.PI / 3), label: 'é¢‘ç‡' }
    ];
    
    // ç»˜åˆ¶å¤–æ¡†ä¸‰è§’å½¢
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    ctx.lineTo(points[1].x, points[1].y);
    ctx.lineTo(points[2].x, points[2].y);
    ctx.closePath();
    ctx.strokeStyle = '#dee2e6';
    ctx.lineWidth = showLabels ? 2 : 1;
    ctx.stroke();
    
    // è®¡ç®—æ•°æ®ç‚¹ä½ç½®
    const maxScore = [10, 10, 8];
    const scores = [winRate, profitRatio, frequency];
    const ratios = scores.map((score, i) => score / maxScore[i]);
    
    // ç»˜åˆ¶æ•°æ®ä¸‰è§’å½¢
    ctx.beginPath();
    ctx.moveTo(
        centerX + (points[0].x - centerX) * ratios[0],
        centerY + (points[0].y - centerY) * ratios[0]
    );
    ctx.lineTo(
        centerX + (points[1].x - centerX) * ratios[1],
        centerY + (points[1].y - centerY) * ratios[1]
    );
    ctx.lineTo(
        centerX + (points[2].x - centerX) * ratios[2],
        centerY + (points[2].y - centerY) * ratios[2]
    );
    ctx.closePath();
    ctx.fillStyle = 'rgba(13, 110, 253, 0.3)';
    ctx.fill();
    ctx.strokeStyle = '#0d6efd';
    ctx.lineWidth = showLabels ? 2 : 1;
    ctx.stroke();
    
    // ç»˜åˆ¶æ•°æ®ç‚¹
    scores.forEach((score, i) => {
        const ratio = ratios[i];
        const x = centerX + (points[i].x - centerX) * ratio;
        const y = centerY + (points[i].y - centerY) * ratio;
        
        ctx.beginPath();
        ctx.arc(x, y, showLabels ? 4 : 2, 0, 2 * Math.PI);
        ctx.fillStyle = '#0d6efd';
        ctx.fill();
    });
}

function updateSort() {
    const sortBy = document.getElementById('sortSelect').value;
    const order = document.getElementById('orderSelect').value;
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.set('order', order);
    window.location.href = url.toString();
}
</script>
{% endblock %}