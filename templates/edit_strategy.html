{% extends "base.html" %}

{% block title %}编辑策略 - 多策略交易跟踪系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-pencil"></i> 编辑策略：{{ strategy.name }}
                    </h4>
                    <a href="{{ url_for('strategies') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> 返回策略列表
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>注意：</strong>修改策略信息可能影响历史交易记录的分类显示，请谨慎操作。
                </div>

                <form id="editStrategyForm">
                    <div class="mb-3">
                        <label for="strategyName" class="form-label">
                            <i class="bi bi-type"></i> 策略名称 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="strategyName" name="name" 
                               value="{{ strategy.name }}" 
                               placeholder="例如：动量轮动策略、趋势反转策略等" required>
                        <div class="form-text">
                            策略名称应该具有描述性，能够清楚地表达策略的核心思想
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="strategyDescription" class="form-label">
                            <i class="bi bi-card-text"></i> 策略描述
                        </label>
                        <textarea class="form-control" id="strategyDescription" name="description" rows="4" 
                                  placeholder="详细描述策略的交易逻辑、适用市场环境、风险控制等...">{{ strategy.description or '' }}</textarea>
                        <div class="form-text">
                            可选填，用于记录策略的详细说明和使用场景
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-tags"></i> 策略标签
                        </label>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">预定义标签</h6>
                                <div class="predefined-tags">
                                    {% for tag in tags %}
                                        {% if tag.is_predefined %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="tags" 
                                                   value="{{ tag.name }}" id="predefined_{{ tag.id }}"
                                                   {{ 'checked' if tag.name in strategy.tags else '' }}>
                                            <label class="form-check-label" for="predefined_{{ tag.id }}">
                                                {{ tag.name }}
                                            </label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="text-muted">自定义标签</h6>
                                <div class="custom-tags">
                                    {% for tag in tags %}
                                        {% if not tag.is_predefined %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" name="tags" 
                                                   value="{{ tag.name }}" id="custom_{{ tag.id }}"
                                                   {{ 'checked' if tag.name in strategy.tags else '' }}>
                                            <label class="form-check-label" for="custom_{{ tag.id }}">
                                                {{ tag.name }}
                                            </label>
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6 class="text-muted">添加新标签</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newTagInput" 
                                       placeholder="输入新标签名称，按回车添加">
                                <button type="button" class="btn btn-outline-success" id="addTagBtn">
                                    <i class="bi bi-plus"></i> 添加
                                </button>
                            </div>
                            <div id="newTagsList" class="mt-2"></div>
                        </div>
                        
                        <div class="form-text">
                            可选择多个标签来描述策略特点，如"轮动+择时"、"趋势+套利"等
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">策略统计信息</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h5 class="text-primary">{{ strategy.trade_count }}</h5>
                                            <small class="text-muted">关联交易数</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h5 class="text-info">{{ strategy.created_at[:10] }}</h5>
                                            <small class="text-muted">创建日期</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <h5 class="text-success">{{ strategy.updated_at[:10] }}</h5>
                                            <small class="text-muted">最后更新</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('strategies') }}" class="btn btn-outline-secondary me-md-2">
                            <i class="bi bi-x-circle"></i> 取消
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 保存修改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newTagsList = new Set(); // 存储新添加的标签
    
    // 添加新标签功能
    function addNewTag() {
        const input = document.getElementById('newTagInput');
        const tagName = input.value.trim();
        
        if (!tagName) {
            alert('请输入标签名称');
            return;
        }
        
        if (newTagsList.has(tagName)) {
            alert('标签已存在');
            return;
        }
        
        // 检查是否已经在现有标签中选中
        const existingChecked = Array.from(document.querySelectorAll('input[name="tags"]:checked'))
            .some(input => input.value === tagName);
        
        if (existingChecked) {
            alert('该标签已被选中');
            return;
        }
        
        newTagsList.add(tagName);
        
        // 创建标签元素
        const tagElement = document.createElement('span');
        tagElement.className = 'badge bg-info me-2 mb-2 d-inline-flex align-items-center';
        tagElement.innerHTML = `
            ${tagName}
            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.75em;" 
                    onclick="removeNewTag('${tagName}', this.parentElement)"></button>
            <input type="hidden" name="tags" value="${tagName}">
        `;
        
        document.getElementById('newTagsList').appendChild(tagElement);
        input.value = '';
    }
    
    // 移除新标签
    window.removeNewTag = function(tagName, element) {
        newTagsList.delete(tagName);
        element.remove();
    };
    
    // 添加标签按钮点击事件
    document.getElementById('addTagBtn').addEventListener('click', addNewTag);
    
    // 新标签输入框回车事件
    document.getElementById('newTagInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addNewTag();
        }
    });
    
    // 表单提交处理
    document.getElementById('editStrategyForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        
        // 验证策略名称
        const name = formData.get('name').trim();
        if (!name) {
            alert('请输入策略名称');
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 保存中...';
        
        fetch('/strategy/{{ strategy.id }}/edit', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('策略修改成功！\n' + data.message);
                window.location.href = '/strategies';
            } else {
                alert('策略修改失败！\n' + data.message);
            }
        })
        .catch(error => {
            console.error('修改失败:', error);
            alert('修改失败，请重试');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> 保存修改';
        });
    });
});
</script>
{% endblock %}