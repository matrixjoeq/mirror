{% extends 'base.html' %}
{% block content %}
    <div class="container">
        <h2>中观观察（全球股指趋势）</h2>

        <div class="row g-3 align-items-end mb-3">
            <div class="col-auto">
                <label for="viewSelect" class="form-label">视图</label>
                <select id="viewSelect" class="form-select form-select-sm">
                    <option value="asset_class" selected>资产大类</option>
                </select>
            </div>
            <div class="col-auto" id="marketPicker" style="display:none;">
                <label for="marketSelect" class="form-label">市场</label>
                <select id="marketSelect" class="form-select form-select-sm">
                    <option value="CN">CN</option>
                    <option value="HK">HK</option>
                    <option value="US" selected>US</option>
                    <option value="EU">EU</option>
                    <option value="JP">JP</option>
                    <option value="UK">UK</option>
                </select>
            </div>
            <div class="col-auto">
                <label for="modeSelect" class="form-label">回报口径</label>
                <select id="modeSelect" class="form-select form-select-sm">
                    <option value="price" selected>价格</option>
                    <option value="total">全收益</option>
                </select>
            </div>
            <div class="col-auto">
                <button id="refreshBtn" class="btn btn-sm btn-primary">刷新榜单</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle" id="rankTable">
                <thead>
                    <tr id="rankHead">
                        <th>名称</th>
                        <th>分数</th>
                    </tr>
                </thead>
                <tbody id="rankBody"></tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted" id="asofInfo"></div>
            <div class="btn-group">
                <a href="/meso/instruments" class="btn btn-outline-secondary btn-sm">观察对象管理</a>
                <a href="/api/meso/instruments" class="btn btn-outline-secondary btn-sm">JSON</a>
            </div>
        </div>
    </div>
    <script>
    (function(){
        const viewSel = document.getElementById('viewSelect');
        const modeSel = document.getElementById('modeSelect');
        const marketPicker = document.getElementById('marketPicker');
        const marketSel = document.getElementById('marketSelect');
        const btn = document.getElementById('refreshBtn');
        const head = document.getElementById('rankHead');
        const body = document.getElementById('rankBody');
        const asofInfo = document.getElementById('asofInfo');

        function updateHead(){
            head.innerHTML = '';
            head.insertAdjacentHTML('beforeend', '<th>资产大类</th><th>强度分</th>');
        }

        async function load(){
            const mode = modeSel.value;
            const top = 20;
            body.innerHTML = '<tr><td colspan="2">加载中…</td></tr>';
            const url = `/api/meso/rankings/asset_class?return_mode=${mode}&top=${top}`;
            try{
                const resp = await fetch(url);
                const json = await resp.json();
                const payload = json && json.data ? json.data : {};
                const list = payload.rankings || [];
                asofInfo.textContent = payload.asof ? `As of ${payload.asof}` : '';
                body.innerHTML = '';
                if(list.length === 0){
                    body.innerHTML = '<tr><td colspan="2">暂无数据</td></tr>';
                    return;
                }
                for(const row of list){
                    let name = row.asset_class || '';
                    const score = (row.score !== undefined && row.score !== null) ? row.score.toFixed(4) : '';
                    body.insertAdjacentHTML('beforeend', `<tr><td>${name}</td><td>${score}</td></tr>`);
                }
            }catch(e){
                body.innerHTML = `<tr><td colspan="2">加载失败：${e}</td></tr>`;
            }
        }

        function onViewChange(){ updateHead(); }

        viewSel.addEventListener('change', () => { onViewChange(); load(); });
        modeSel.addEventListener('change', load);
        marketSel.addEventListener('change', load);
        btn.addEventListener('click', load);

        onViewChange();
        load();
    })();
    </script>
{% endblock %}
