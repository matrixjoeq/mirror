{% extends "base.html" %}

{% block title %}{{ strategy_name }}详情 - 策略评分{% endblock %}

{% block content %}
<!-- 策略总体评分 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-diagram-3"></i> {{ strategy_name }} - 总体表现
                    <a href="{{ url_for('analysis.strategy_scores') }}" class="btn btn-outline-secondary btn-sm float-end">
                        <i class="bi bi-arrow-left"></i> 返回概览
                    </a>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center">
                        <canvas id="overall-triangle" width="220" height="200"></canvas>
                    </div>
                    <div class="col-md-9">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="text-primary">{{ strategy_score.total_score }}分</h4>
                                <span class="badge 
                                    {% if strategy_score.total_score >= 26 %}bg-primary
                                    {% elif strategy_score.total_score >= 23 %}bg-success
                                    {% elif strategy_score.total_score >= 20 %}bg-info
                                    {% elif strategy_score.total_score >= 18 %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ strategy_score.rating }}
                                </span>
                                
                                <div class="mt-3">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong>胜率得分:</strong> {{ strategy_score.win_rate_score }}分<br>
                                            <strong>盈亏比得分:</strong> {{ strategy_score.profit_loss_ratio_score }}分<br>
                                            <strong>频率得分:</strong> {{ strategy_score.frequency_score }}分
                                        </div>
                                        <div class="col-6">
                                            <strong>交易总数:</strong> {{ strategy_score.stats.total_trades }}笔<br>
                                            <strong>胜率:</strong> {{ strategy_score.stats.win_rate }}%<br>
                                            <strong>平均盈亏比:</strong> {{ strategy_score.stats.avg_profit_loss_ratio }}:1<br>
                                            <strong>平均持仓:</strong> {{ strategy_score.stats.avg_holding_days }}天
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>表现分析</h6>
                                <div class="small">
                                    {% if strategy_score.win_rate_score >= 8 %}
                                    <div class="text-success"><i class="bi bi-check-circle"></i> 胜率表现优秀</div>
                                    {% elif strategy_score.win_rate_score >= 6 %}
                                    <div class="text-info"><i class="bi bi-info-circle"></i> 胜率表现合格</div>
                                    {% else %}
                                    <div class="text-warning"><i class="bi bi-exclamation-triangle"></i> 胜率有待提升</div>
                                    {% endif %}
                                    
                                    {% if strategy_score.profit_loss_ratio_score >= 8 %}
                                    <div class="text-success"><i class="bi bi-check-circle"></i> 盈亏比表现优秀</div>
                                    {% elif strategy_score.profit_loss_ratio_score >= 6 %}
                                    <div class="text-info"><i class="bi bi-info-circle"></i> 盈亏比表现合格</div>
                                    {% else %}
                                    <div class="text-warning"><i class="bi bi-exclamation-triangle"></i> 盈亏比有待提升</div>
                                    {% endif %}
                                    
                                    {% if strategy_score.frequency_score >= 6 %}
                                    <div class="text-success"><i class="bi bi-check-circle"></i> 交易频率表现良好</div>
                                    {% elif strategy_score.frequency_score >= 4 %}
                                    <div class="text-info"><i class="bi bi-info-circle"></i> 交易频率表现一般</div>
                                    {% else %}
                                    <div class="text-warning"><i class="bi bi-exclamation-triangle"></i> 交易频率偏低</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 各标的表现 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> 各标的表现明细
                </h6>
            </div>
            <div class="card-body">
                {% if symbol_scores %}
                <!-- 排序控制 -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">排序方式:</label>
                        <select class="form-select form-select-sm" id="sortSelect" onchange="updateSort()">
                            <option value="total_score" {{ 'selected' if sort_by == 'total_score' else '' }}>总分</option>
                            <option value="win_rate_score" {{ 'selected' if sort_by == 'win_rate_score' else '' }}>胜率得分</option>
                            <option value="profit_loss_ratio_score" {{ 'selected' if sort_by == 'profit_loss_ratio_score' else '' }}>盈亏比得分</option>
                            <option value="frequency_score" {{ 'selected' if sort_by == 'frequency_score' else '' }}>频率得分</option>
                            <option value="symbol_code" {{ 'selected' if sort_by == 'symbol_code' else '' }}>标的代码</option>
                            <option value="win_rate" {{ 'selected' if sort_by == 'win_rate' else '' }}>胜率</option>
                            <option value="avg_profit_loss_ratio" {{ 'selected' if sort_by == 'avg_profit_loss_ratio' else '' }}>盈亏比</option>
                            <option value="avg_holding_days" {{ 'selected' if sort_by == 'avg_holding_days' else '' }}>持仓天数</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">排序顺序:</label>
                        <select class="form-select form-select-sm" id="orderSelect" onchange="updateSort()">
                            <option value="desc" {{ 'selected' if sort_order == 'desc' else '' }}>降序</option>
                            <option value="asc" {{ 'selected' if sort_order == 'asc' else '' }}>升序</option>
                        </select>
                    </div>
                </div>
                
                <!-- 表格 -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>标的</th>
                                <th>总分</th>
                                <th>评级</th>
                                <th>胜率得分</th>
                                <th>盈亏比得分</th>
                                <th>频率得分</th>
                                <th>交易数</th>
                                <th>胜率</th>
                                <th>盈亏比</th>
                                <th>持仓天数</th>
                                <th>交易费用</th>
                                <th>费用占比</th>
                                <th>三角图</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for score in symbol_scores %}
                            <tr>
                                <td>
                                    <strong>{{ score.symbol_code }}</strong><br>
                                    <small class="text-muted">{{ score.symbol_name }}</small>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if score.total_score >= 26 %}bg-primary
                                        {% elif score.total_score >= 23 %}bg-success
                                        {% elif score.total_score >= 20 %}bg-info
                                        {% elif score.total_score >= 18 %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ score.total_score }}分
                                    </span>
                                </td>
                                <td>{{ score.rating }}</td>
                                <td>{{ score.win_rate_score }}</td>
                                <td>{{ score.profit_loss_ratio_score }}</td>
                                <td>{{ score.frequency_score }}</td>
                                <td>{{ score.stats.total_trades }}</td>
                                <td>{{ score.stats.win_rate }}%</td>
                                <td>{{ score.stats.avg_profit_loss_ratio }}:1</td>
                                <td>{{ score.stats.avg_holding_days }}</td>
                                <td>{{ score.stats.total_transaction_fees }}</td>
                                <td>{{ score.stats.total_fee_ratio }}%</td>
                                <td>
                                    <canvas id="triangle-{{ score.symbol_code }}" width="80" height="70"></canvas>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <h5>暂无数据</h5>
                    <p>该策略下还没有已平仓的交易记录</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 绘制总体评分三角图
    drawTriangleScore('overall-triangle', 
                     {{ strategy_score.win_rate_score }}, 
                     {{ strategy_score.profit_loss_ratio_score }}, 
                     {{ strategy_score.frequency_score }}, 
                     true);
    
    // 绘制各标的的小三角图
    {% for score in symbol_scores %}
    drawTriangleScore('triangle-{{ score.symbol_code }}', 
                     {{ score.win_rate_score }}, 
                     {{ score.profit_loss_ratio_score }}, 
                     {{ score.frequency_score }}, 
                     false);
    {% endfor %}
});

function drawTriangleScore(canvasId, winRate, profitRatio, frequency, showLabels = false) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = (canvas.height / 2) + (showLabels ? 15 : 0); // 大图向下偏移
    const radius = showLabels ? 65 : 25;
    
    // 清除画布
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 三角形顶点坐标
    const points = [
        { x: centerX, y: centerY - radius, label: '胜率' },
        { x: centerX - radius * Math.sin(Math.PI / 3), y: centerY + radius * Math.cos(Math.PI / 3), label: '盈亏比' },
        { x: centerX + radius * Math.sin(Math.PI / 3), y: centerY + radius * Math.cos(Math.PI / 3), label: '频率' }
    ];
    
    // 绘制外框三角形
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    ctx.lineTo(points[1].x, points[1].y);
    ctx.lineTo(points[2].x, points[2].y);
    ctx.closePath();
    ctx.strokeStyle = '#dee2e6';
    ctx.lineWidth = showLabels ? 2 : 1;
    ctx.stroke();
    
    // 计算数据点位置
    const maxScore = [10, 10, 8];
    const scores = [winRate, profitRatio, frequency];
    const ratios = scores.map((score, i) => score / maxScore[i]);
    
    // 绘制数据三角形
    ctx.beginPath();
    ctx.moveTo(
        centerX + (points[0].x - centerX) * ratios[0],
        centerY + (points[0].y - centerY) * ratios[0]
    );
    ctx.lineTo(
        centerX + (points[1].x - centerX) * ratios[1],
        centerY + (points[1].y - centerY) * ratios[1]
    );
    ctx.lineTo(
        centerX + (points[2].x - centerX) * ratios[2],
        centerY + (points[2].y - centerY) * ratios[2]
    );
    ctx.closePath();
    ctx.fillStyle = 'rgba(13, 110, 253, 0.3)';
    ctx.fill();
    ctx.strokeStyle = '#0d6efd';
    ctx.lineWidth = showLabels ? 2 : 1;
    ctx.stroke();
    
    // 绘制数据点
    scores.forEach((score, i) => {
        const ratio = ratios[i];
        const x = centerX + (points[i].x - centerX) * ratio;
        const y = centerY + (points[i].y - centerY) * ratio;
        
        ctx.beginPath();
        ctx.arc(x, y, showLabels ? 4 : 2, 0, 2 * Math.PI);
        ctx.fillStyle = '#0d6efd';
        ctx.fill();
    });
    
    // 添加标签（仅大图显示）
    if (showLabels) {
        ctx.fillStyle = '#495057';
        ctx.font = '13px Arial';
        ctx.textAlign = 'center';
        
        points.forEach((point, i) => {
            let labelY, scoreY;
            if (i === 0) { // 顶部标签
                labelY = point.y - 25;
                scoreY = point.y - 10;
            } else { // 底部标签
                labelY = point.y + 18;
                scoreY = point.y + 32;
            }
            ctx.fillText(point.label, point.x, labelY);
            ctx.fillText(scores[i].toString(), point.x, scoreY);
        });
    }
}

function updateSort() {
    const sortBy = document.getElementById('sortSelect').value;
    const order = document.getElementById('orderSelect').value;
    const url = new URL(window.location);
    url.searchParams.set('sort', sortBy);
    url.searchParams.set('order', order);
    window.location.href = url.toString();
}
</script>
{% endblock %}