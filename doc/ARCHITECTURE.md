# 系统架构文档

## 概述

多策略系统分析采用模块化架构设计，将原本的单一巨大文件重构为职责清晰的多个模块，提高代码的可维护性、可扩展性和可测试性。经过严格的重构和测试验证，系统核心功能已通过完整测试；性能用例通过，覆盖统计将于下一阶段继续提升。

## 架构设计

### 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Presentation  │    │    Business     │    │      Data       │
│      Layer      │    │     Logic       │    │     Layer       │
│                 │    │     Layer       │    │                 │
│   Routes + UI   │◄──►│   Services      │◄──►│   Database      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 目录结构

```
mirror/
├── app.py                    # 主应用文件（Flask应用工厂）
├── config.py                 # 配置管理
├── models/                   # 数据模型层
│   ├── __init__.py
│   ├── trading.py           # 交易相关数据模型
│   └── strategy.py          # 策略相关数据模型
├── services/                # 业务逻辑层
│   ├── __init__.py
│   ├── database_service.py  # 数据库操作服务
│   ├── trading_service.py   # 交易业务逻辑
│   ├── strategy_service.py  # 策略业务逻辑
│   └── analysis_service.py  # 分析业务逻辑
├── routes/                  # 表现层（路由）
│   ├── __init__.py
│   ├── main_routes.py       # 主页面路由
│   ├── trading_routes.py    # 交易相关路由
│   ├── strategy_routes.py   # 策略相关路由
│   ├── analysis_routes.py   # 分析相关路由
│   └── api_routes.py        # API路由
├── utils/                   # 工具模块
│   ├── __init__.py
│   ├── helpers.py           # 辅助函数
│   └── decorators.py        # 装饰器
├── templates/               # 模板文件
├── static/                  # 静态资源
└── tests/                   # 测试文件
```

## 各层详细说明

### 1. 表现层 (Presentation Layer)

**责任**: 处理HTTP请求和响应，用户界面渲染

#### 路由模块分工
- `main_routes.py`: 主页、仪表板等核心页面
- `trading_routes.py`: 交易相关页面（买入、卖出、交易列表等）
- `strategy_routes.py`: 策略管理页面（创建、编辑、删除策略）
- `analysis_routes.py`: 分析页面（策略评分、对比分析等）
- `api_routes.py`: REST API端点

#### 设计原则
- 每个路由模块使用Flask Blueprint组织
- 路由处理函数只负责请求解析和响应渲染
- 业务逻辑委托给服务层处理
- 统一错误处理和日志记录

### 2. 业务逻辑层 (Business Logic Layer)

**责任**: 实现核心业务逻辑，数据验证和处理

#### 服务模块分工
- `DatabaseService`: 数据库连接管理、基础CRUD操作
- `TradingService`: 交易相关业务逻辑（买入、卖出、交易管理）
- `StrategyService`: 策略管理业务逻辑（策略CRUD、标签管理）
- `AnalysisService`: 分析计算业务逻辑（策略评分、统计分析）

#### 设计原则
- 每个服务类职责单一
- 服务间通过依赖注入协作
- 统一的错误处理和返回格式
- 业务逻辑与数据库操作分离

### 3. 数据层 (Data Layer)

**责任**: 数据存储和访问

#### 数据模型
- `Trade`: 交易主记录
- `TradeDetail`: 交易明细记录  
- `TradeModification`: 交易修改历史
- `Strategy`: 投资策略
- `Tag`: 标签

#### 数据库设计
- SQLite数据库
- 支持事务操作
- 软删除机制
- 审计日志记录
- 盈利字段口径：
  - 明细：`gross_profit`/`net_profit` 以及对应比例；毛利按不含费买入均价计算，净利=毛利−卖出手续费
  - 主表：`total_gross_profit`/`total_net_profit` 及净利率；旧字段 `total_profit_loss` 继续代表毛利（兼容）

## 模块间依赖关系

```
Routes Layer
    ↓ (uses)
Services Layer
    ↓ (uses)
Database Service
    ↓ (uses)
Data Models
```

### 依赖注入
- 服务类通过构造函数接收依赖
- 支持测试时的模拟对象注入
- 保持松耦合设计

## 配置管理

### 配置类层次
```python
Config (基础配置)
├── DevelopmentConfig (开发环境)
├── ProductionConfig (生产环境)
└── TestingConfig (测试环境)
```

### 配置项分类
- 数据库配置
- Flask应用配置
- 业务逻辑配置
- 环境特定配置

## 错误处理策略

### 分层错误处理
1. **路由层**: HTTP状态码处理，用户友好错误页面
2. **服务层**: 业务异常处理，返回结构化错误信息
3. **数据层**: 数据库异常处理，事务回滚

### 错误类型
- 业务逻辑错误：400 Bad Request
- 权限错误：403 Forbidden  
- 资源不存在：404 Not Found
- 服务器错误：500 Internal Server Error

## 测试策略

### 测试层次（阶段性）
1. 单元测试：≥90%（达标）
2. 集成测试：≥67%（达标）
3. 功能测试：≥80%（达标）
4. 性能测试：用例通过，覆盖后续提升

### 测试原则
- 每个服务类都有对应的单元测试
- 使用依赖注入进行测试隔离
- 测试数据库使用临时文件
- 测试后自动清理数据
- 严格的数据库隔离确保测试环境独立性
- 端到端工作流测试覆盖完整用户场景

## 扩展指南

### 添加新功能
1. **确定功能归属**: 判断属于哪个业务领域
2. **扩展数据模型**: 如需要，添加新的数据模型
3. **实现业务逻辑**: 在相应服务类中添加方法
4. **添加路由处理**: 在相应路由模块中添加端点
5. **编写测试**: 为新功能编写测试用例

### 性能优化
1. **数据库层**: 添加索引、查询优化
2. **业务层**: 缓存机制、批量操作
3. **表现层**: 分页、异步加载

### 安全考虑
1. **输入验证**: 在服务层进行严格验证
2. **权限控制**: 在路由层添加权限检查
3. **SQL注入防护**: 使用参数化查询
4. **XSS防护**: 模板自动转义

## 部署架构

### 开发环境
- 本地SQLite数据库
- Flask开发服务器
- 调试模式开启

### 生产环境
- 生产数据库（SQLite或其他）
- WSGI服务器（Gunicorn等）
- 反向代理（Nginx等）
- 日志管理
- 监控和告警

## 维护指南

### 代码风格
- 遵循PEP 8规范
- 使用类型注解
- 添加文档字符串
- 保持函数简洁

### 版本控制
- 功能分支开发
- 代码审查
- 自动化测试
- 持续集成

### 监控指标
- 应用性能监控
- 错误率监控
- 业务指标监控
- 数据库性能监控
